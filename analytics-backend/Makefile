.PHONY: setup install run test clean docker-build docker-run help

# VariÃ¡veis
PYTHON := python3
PIP := pip3
UVICORN := uvicorn
DOCKER := docker
COMPOSE := docker-compose

# ConfiguraÃ§Ã£o padrÃ£o
.DEFAULT_GOAL := help

# Setup completo do ambiente
setup: ## ğŸš€ Setup completo (dependÃªncias + banco)
	@echo "ğŸš€ Configurando ambiente Analytics ML..."
	$(PYTHON) setup.py

# Instalar dependÃªncias apenas
install: ## ğŸ“¦ Instalar dependÃªncias Python
	@echo "ğŸ“¦ Instalando dependÃªncias..."
	$(PIP) install -r requirements.txt

# Executar servidor de desenvolvimento
run: ## ğŸƒ Executar servidor de desenvolvimento
	@echo "ğŸƒ Iniciando servidor de desenvolvimento..."
	$(PYTHON) main.py

# Executar com uvicorn (recomendado)
serve: ## ğŸš€ Executar com uvicorn (produÃ§Ã£o)
	@echo "ğŸš€ Iniciando servidor com uvicorn..."
	$(UVICORN) main:app --host 0.0.0.0 --port 8000 --reload

# Executar testes
test: ## ğŸ§ª Executar testes da API
	@echo "ğŸ§ª Executando testes..."
	$(PYTHON) test_ml_api.py

# Limpar arquivos temporÃ¡rios
clean: ## ğŸ§¹ Limpar arquivos temporÃ¡rios
	@echo "ğŸ§¹ Limpando arquivos temporÃ¡rios..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name ".pytest_cache" -delete
	rm -f .coverage

# Build Docker
docker-build: ## ğŸ³ Build imagem Docker
	@echo "ğŸ³ Construindo imagem Docker..."
	$(DOCKER) build -t analytics-ml .

# Executar com Docker
docker-run: ## ğŸ³ Executar container Docker
	@echo "ğŸ³ Executando container..."
	$(DOCKER) run -p 8000:8000 analytics-ml

# Executar com docker-compose
up: ## ğŸš€ Iniciar com docker-compose
	@echo "ğŸš€ Iniciando serviÃ§os..."
	$(COMPOSE) up -d

# Parar docker-compose
down: ## ğŸ›‘ Parar serviÃ§os docker-compose
	@echo "ğŸ›‘ Parando serviÃ§os..."
	$(COMPOSE) down

# Rebuild e restart
restart: ## ğŸ”„ Rebuild e reiniciar serviÃ§os
	@echo "ğŸ”„ Reiniciando serviÃ§os..."
	$(COMPOSE) down
	$(COMPOSE) up -d --build

# Ver logs
logs: ## ğŸ“‹ Ver logs dos containers
	@echo "ğŸ“‹ Visualizando logs..."
	$(COMPOSE) logs -f analytics-api

# Verificar status dos serviÃ§os
status: ## ğŸ“Š Verificar status da API
	@echo "ğŸ“Š Verificando status..."
	@curl -s http://localhost:8000/ | python -m json.tool || echo "âŒ API nÃ£o estÃ¡ respondendo"

# Backup do banco
backup: ## ğŸ’¾ Backup do banco de dados
	@echo "ğŸ’¾ Criando backup do banco..."
	@cp analytics.db backup_$(shell date +%Y%m%d_%H%M%S).db
	@echo "âœ… Backup criado: backup_$(shell date +%Y%m%d_%H%M%S).db"

# Verificar dependÃªncias
check-deps: ## ğŸ” Verificar dependÃªncias instaladas
	@echo "ğŸ” Verificando dependÃªncias..."
	@$(PIP) list | grep -E "(fastapi|uvicorn|pandas|scikit-learn)"

# Atualizar dependÃªncias
update-deps: ## ğŸ“ˆ Atualizar dependÃªncias
	@echo "ğŸ“ˆ Atualizando dependÃªncias..."
	$(PIP) install --upgrade -r requirements.txt

# Gerar requirements atualizado
freeze: ## â„ï¸ Gerar requirements.txt atualizado
	@echo "â„ï¸ Gerando requirements.txt..."
	$(PIP) freeze > requirements.txt

# Executar modo desenvolvimento com auto-reload
dev: ## ğŸ› ï¸ Modo desenvolvimento com auto-reload
	@echo "ğŸ› ï¸ Iniciando modo desenvolvimento..."
	$(UVICORN) main:app --host 0.0.0.0 --port 8000 --reload --log-level debug

# Verificar cÃ³digo com linting
lint: ## ğŸ§¹ Verificar cÃ³digo (se flake8 estiver instalado)
	@echo "ğŸ§¹ Verificando cÃ³digo..."
	@$(PYTHON) -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "â„¹ï¸ flake8 nÃ£o instalado"

# Instalar dependÃªncias de desenvolvimento
dev-install: ## ğŸ› ï¸ Instalar dependÃªncias de desenvolvimento
	@echo "ğŸ› ï¸ Instalando deps de desenvolvimento..."
	$(PIP) install flake8 pytest black

# Formatar cÃ³digo
format: ## âœ¨ Formatar cÃ³digo com black (se instalado)
	@echo "âœ¨ Formatando cÃ³digo..."
	@$(PYTHON) -m black . || echo "â„¹ï¸ black nÃ£o instalado (pip install black)"

# Verificar saÃºde da API
health: ## ğŸ¥ Verificar saÃºde da API
	@echo "ğŸ¥ Verificando saÃºde da API..."
	@curl -s http://localhost:8000/api/analytics -H "Authorization: Bearer yasmin-token" | head -100 || echo "âŒ Endpoint analytics indisponÃ­vel"

# InformaÃ§Ãµes do sistema
info: ## â„¹ï¸ InformaÃ§Ãµes do sistema
	@echo "â„¹ï¸ InformaÃ§Ãµes do sistema:"
	@echo "Python: $(shell $(PYTHON) --version)"
	@echo "Pip: $(shell $(PIP) --version)"
	@echo "Docker: $(shell $(DOCKER) --version 2>/dev/null || echo 'NÃ£o instalado')"
	@echo "Compose: $(shell $(COMPOSE) --version 2>/dev/null || echo 'NÃ£o instalado')"

# Limpeza completa
clean-all: clean ## ğŸ§¹ Limpeza completa (cache + containers)
	@echo "ğŸ§¹ Limpeza completa..."
	$(COMPOSE) down --rmi all --volumes --remove-orphans 2>/dev/null || echo "Containers jÃ¡ removidos"
	$(DOCKER) system prune -f 2>/dev/null || echo "Docker nÃ£o disponÃ­vel"

# Ajuda
help: ## ğŸ“š Mostrar esta ajuda
	@echo "ğŸ¤– Analytics ML Backend - Comandos DisponÃ­veis:"
	@echo ""
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "ğŸ“‹ Exemplos de uso:"
	@echo "  make setup          # ConfiguraÃ§Ã£o inicial completa"
	@echo "  make dev            # Desenvolvimento com auto-reload"
	@echo "  make test           # Executar todos os testes"
	@echo "  make up             # Docker compose up"
	@echo "  make status         # Verificar se API estÃ¡ funcionando"
	@echo ""
	@echo "ğŸ”— URLs importantes:"
	@echo "  http://localhost:8000/        # Status da API"
	@echo "  http://localhost:8000/docs    # DocumentaÃ§Ã£o Swagger"
	@echo "  http://localhost:8000/api/analytics # Analytics ML"

# Venv helpers
VENV=.venv
PY=$(VENV)/bin/python
PIPV=$(VENV)/bin/pip
UV=$(VENV)/bin/uvicorn

venv: ## ğŸ Criar venv Python 3.12 em .venv
	@test -d $(VENV) || /opt/homebrew/bin/python3.12 -m venv $(VENV)
	@echo "âœ… venv pronto em $(VENV)"

setup-venv: venv ## ğŸ“¦ Instalar deps no venv
	$(PIPV) install -U pip
	$(PIPV) install -r requirements.txt

serve-venv: ## ğŸš€ Iniciar servidor com venv (uvicorn)
	$(UV) main:app --host 0.0.0.0 --port 8000 --reload

vrun: ## ğŸƒ Executar main.py usando venv
	$(PY) main.py

test-api: ## ğŸ§ª Testar endpoints principais
	@curl -s http://127.0.0.1:8000/ | python -m json.tool || true
	@curl -s -H "Authorization: Bearer yasmin-token" http://127.0.0.1:8000/api/weekly-goals | head -100 || true
	@curl -s -H "Authorization: Bearer yasmin-token" http://127.0.0.1:8000/api/analytics | head -100 || true